ğŸ“„ Specifiche implementazione inviti WordPress per gioco multiplayer Unity3D con Relay
ğŸ¯ Obiettivo
Permettere a un utente pagante sulla piattaforma WordPress di:
Selezionare un gioco Unity (WebGL) disponibile
Invitare fino a 3 utenti registrati
Avviare una sessione multiplayer in tempo reale usando Unity Relay
Gestire tutto il flusso tramite WordPress, senza dipendenze da Unity Lobby

ğŸ§© Componenti principali


ğŸ“¦ Struttura dati (DB)
Tabella: wp_game_sessions


Tabella: wp_game_session_invites


ğŸ”— Link invito
Ogni sessione genera un link del tipo:

https://miosito.it/gioca?invito=56fb1d23-aa22-4ed3-910b-8c29ab763111
// Accesso consentito solo a host e utenti invitati (login WP obbligatorio).


âš™ï¸ Flusso dâ€™uso
WordPress:
- Registra la sessione (wp_game_sessions) con invito_uuid e expires_at = now+24h
- Registra gli invitati (riuso wp_giochi_invitati, con session_id)
ğŸŸ¢ Creazione sessione (host)
Lâ€™utente paga o ha diritto a giocare
Seleziona un gioco Unity
Sceglie fino a 3 utenti da una rubrica (autocomplete WP)
Clicca â€œCrea partitaâ€
WordPress:
Registra la sessione (wp_game_sessions)
Registra gli invitati (wp_game_session_invites)
Genera link univoco
Lâ€™interfaccia mostra il link da condividere

ğŸŸ¡ Avvio sessione (Unity host)

Lâ€™host apre il link da loggato
WordPress verifica che Ã¨ lâ€™host â†’ carica Unity WebGL
Unity crea Relay Allocation (es. per 3 peer)
Unity ottiene joinCode â†’  Unity invia a WP:
POST /wp-json/game/v1/set-join-code
{ invito_uuid: "...", joinCode: "XYZ123" }
Effetto:
- Aggiorna join_code
- status = "started"
- Estende expires_at di +2h (finestra runtime)

// TEST -> 
// Esegui dal contesto della pagina del gioco (dove vedi UNITY_NONCE e INVITO_UUID)
fetch('/wp-json/game/v1/set-join-code', {
  method: 'POST',
  headers: {'Content-Type':'application/json','X-WP-Nonce': UNITY_NONCE},
  body: JSON.stringify({ invito_uuid: INVITO_UUID, joinCode: 'ABC123' })
}).then(r=>r.json()).then(console.log)


ğŸ”µ Accesso invitati
Lâ€™invitato apre il link da loggato
WordPress verifica che Ã¨ nella lista â†’ carica Unity WebGL
Unity effettua polling:
GET /wp-json/game/v1/get-join-code?invito_uuid=...
Header: X-WP-Nonce (wp_rest)
â†’ finchÃ© non riceve joinCode
Unity si connette a Relay con il codice

ğŸ”„ API REST (WordPress â†’ Unity)
GET /wp-json/game/v1/get-join-code
- Input: invito_uuid
- Output:
  {
    "status": "ok",
    "joinCode": "XYZ123" | null,
    "isGuest": true|false,
    "guestId": 123
  }
- Errori possibili: 401 auth_required, 403 forbidden, 404 session_not_found, 410 expired

POST /wp-json/game/v1/set-join-code
- Input:
  { "invito_uuid": "...", "joinCode": "XYZ123" }
- Autenticazione: host loggato
- Errori possibili: 401, 403, 404, 410, 500

Autenticazione: host loggato Effetto: aggiorna la sessione

ğŸ” Sicurezza
- Login obbligatorio
- Verifiche:
  - is_host â†’ puÃ² inviare joinCode
  - is_invited_user â†’ puÃ² accedere
- Gating applicato sia su /gioca (page-gioca.php) sia sul singolo gioco (single-gioco.php)
- Link non condivisibili con utenti non autorizzati
Tutti gli accessi richiedono current_user loggato
Verifiche su:
is_host â†’ puÃ² inviare joinCode
is_invited_user â†’ puÃ² accedere al gioco

â³ Scadenza inviti/sessioni
- expires_at impostato alla creazione (+24h)
- API e pagine rifiutano accesso se scaduta (HTTP 410)
- Alla chiamata set-join-code, la scadenza viene estesa di +2h per la durata della sessione

ğŸ›ï¸ Limiti
- Massimo 3 invitati per sessione (enforced lato server)

ğŸ“Œ Deviazioni progettuali rispetto al disegno iniziale
- Tabella inviti dedicata (wp_game_session_invites) non creata:
  si riusa wp_giochi_invitati aggiungendo session_id, indici e binding utente_id
- Legacy â€œtokenâ€ per i Giochi: rimosso (campo mantenuto nullable per compatibilitÃ  schema)

ğŸ”§ Estensioni future (opzionali)
Notifiche email agli invitati
Pannello â€œLe mie partiteâ€ per host e guest
Riconnessione a sessioni attive
Chat pre-partita
Statistiche post-partita

âœ… Requisiti minimi sistema

ğŸ“ Changelog
- 2025-09-25: introdotta scadenza inviti (expires_at), estensione +2h su set-join-code, limite 3 invitati per sessione, gating doppio; documentato riuso wp_giochi_invitati e deprecazione token




	